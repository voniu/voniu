


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>  写给学弟：怎样用编程督促晚间打卡 |    渡</title>
  <meta name="description" content="王同学的个人记录">
  <!-- 标签页图标 -->
  

  <!-- 图标库 -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.2.0/fonts/remixicon.css" rel="stylesheet">
  <!-- 动画库 -->
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fushaolei/cdn-white@1.0/css/animate.css"/>
  
  <!-- css文件 -->
  
<link rel="stylesheet" href="/css/white.css">

  <!-- 代码高亮 -->
  
    
      
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.1.1/styles/github.css">

    
  
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="渡" type="application/atom+xml">
</head>


<body>

<div class="menu-outer">
    <div class="menu-inner">
      <div class="menu-site-name  animate__animated  animate__fadeInUp">
        <a href="/">
          渡
        </a>
        
      </div>
      <div class="menu-group">
        <ul class="menu-ul">
        
          <a href="/" class="nav-link">
            <li class="menu-li  animate__animated  animate__fadeInUp">
              首页
            </li>
          </a>
        
          <a href="/archives" class="nav-link">
            <li class="menu-li  animate__animated  animate__fadeInUp">
              文章
            </li>
          </a>
        
          <a href="/links" class="nav-link">
            <li class="menu-li  animate__animated  animate__fadeInUp">
              友链
            </li>
          </a>
        
          <a href="/about" class="nav-link">
            <li class="menu-li  animate__animated  animate__fadeInUp">
              关于
            </li>
          </a>
        
        
        
          <a href="/atom.xml">
            <li class="menu-li  animate__animated  animate__fadeInUp">
              <i class="ri-rss-line"></i>
            </li>
          </a>
        
        
        <a href="/search">
          <li class="menu-li  animate__animated  animate__fadeInUp">
            <i class="ri-search-line"></i>
          </li>
        </a>
        
          <li class="menu-li animate__animated  animate__fadeInUp" id="mobile-menu">
            <i class="ri-menu-line"></i>
          </li>
        
        </ul>

      </div>

    </div>
</div>
<div id="mobile-main" class="animate__animated  animate__fadeIn">
  <div class="mobile-menu-inner">
    <div class="mobile-menu-site-name animate__animated  animate__fadeInUp">
      <a href="/">
        渡
      </a>
    </div>
    <div class="mobile-menu-group" id="mobile-close">
      <i class="ri-close-line"></i>
    </div>

  </div>

  <div class="mobile-menu-div">
  
    <a href="/" class="mobile-nav-link">
      <div class="mobile-menu-child animate__animated  animate__fadeInUp">
        <span>首页</span>
      </div>
    </a>
  
    <a href="/archives" class="mobile-nav-link">
      <div class="mobile-menu-child animate__animated  animate__fadeInUp">
        <span>文章</span>
      </div>
    </a>
  
    <a href="/links" class="mobile-nav-link">
      <div class="mobile-menu-child animate__animated  animate__fadeInUp">
        <span>友链</span>
      </div>
    </a>
  
    <a href="/about" class="mobile-nav-link">
      <div class="mobile-menu-child animate__animated  animate__fadeInUp">
        <span>关于</span>
      </div>
    </a>
  
  
    <a href="/search">  
      <div class="mobile-menu-child  animate__animated  animate__fadeInUp">
        <i class="ri-search-line"></i>
      </div>
    </a>
    
  </div>


</div>

<div class="body-outer">
  <div class="body-inner">
    
<article class="post-inner">
  <div class="post-content-outer">
    <div class="post-intro">
      <div class="post-title animate__animated  animate__fadeInUp">写给学弟：怎样用编程督促晚间打卡</div>
      <div class="meta-intro animate__animated  animate__fadeInUp">Nov 21 2021</div>
      
        <div class="post-cover"><img src="/images/打卡.png" class="post-cover-img"></div>
      
    </div>
    <div class="post-content-inner">
      <div class="post-content-inner-space">

      </div>
      <div class="post-content-main animate__animated  animate__fadeInUp">
        <!-- top型目录 -->
        
        <h1 id="写给学弟：怎样用编程督促晚间打卡"><a href="#写给学弟：怎样用编程督促晚间打卡" class="headerlink" title="写给学弟：怎样用编程督促晚间打卡"></a>写给学弟：怎样用编程督促晚间打卡</h1><blockquote>
<p><strong>免责声明</strong>：本文是作者闲暇之余，出于学习目的而作，仅供学习与讨论，严禁用于违法违规用途，违者后果自负</p>
</blockquote>
<h2 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h2><p>自从学校要求每天打卡后，班干部就忙碌起来了</p>
<p><img   src="/2021/11/21/21ffd4d4cd1a/QQ%E8%81%8A%E5%A4%A9.jpeg" loading="lazy"></p>
<p>这些人力一定程度上是浪费，让我们看一下，班干部做的事是很固定的</p>
<ol>
<li>打卡开始时刻一条消息，提醒大家今天打卡</li>
<li>打卡临近结束时候进入后台查看有谁没有打卡，在群里提醒特定的人</li>
<li>不断重复过程2，直至全员打卡或打卡时间结束</li>
</ol>
<p>我们今天要做的就是用程序代替这一番行为</p>
<h2 id="仅仅想使用"><a href="#仅仅想使用" class="headerlink" title="仅仅想使用"></a>仅仅想使用</h2><h3 id="程序效果"><a href="#程序效果" class="headerlink" title="程序效果"></a>程序效果</h3><p>设定了一个被通知人（例如班长），和一个被通知 QQ 群（你的班群）</p>
<p><img   src="/2021/11/21/21ffd4d4cd1a/%E6%B5%81%E7%A8%8B%E5%9B%BE.png" loading="lazy"></p>
<p><img   src="/2021/11/21/21ffd4d4cd1a/%E9%80%9A%E7%9F%A5%E6%95%88%E6%9E%9C.png" loading="lazy"></p>
<p><img   src="/2021/11/21/21ffd4d4cd1a/%E5%AE%8C%E6%88%90%E9%80%9A%E7%9F%A5.png" loading="lazy"></p>
<h3 id="准备服务器并安装环境"><a href="#准备服务器并安装环境" class="headerlink" title="准备服务器并安装环境"></a>准备服务器并安装环境</h3><p>如果没有可以在<a target="_blank" rel="noopener" href="https://cloud.tencent.com/act/double11?spread_hash_key=97cf1d577d307fbf1213682a8c712217&cps_key=e7b5f8ca4838aad97da492f656e0c457">这里</a>按需求购买，最便宜的1核1G也可以满足需求，推荐 Ubuntu 系统镜像</p>
<p>安装 node 环境，提供一个 <a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/760687">Ubuntu 下 安装 node 教程</a></p>
<p>如果你在服务器输入 <code>node -v</code> 和 <code>npm -v</code> 有版本输出即可</p>
<p><img   src="/ndoe.png" loading="lazy"></p>
<h3 id="准备好-qmsg-机器人"><a href="#准备好-qmsg-机器人" class="headerlink" title="准备好 qmsg 机器人"></a>准备好 qmsg 机器人</h3><p>打开 <a target="_blank" rel="noopener" href="https://qmsg.zendee.cn/">qmsg 酱官网</a>，注册登录</p>
<p>进入<a target="_blank" rel="noopener" href="https://qmsg.zendee.cn/me.html">管理台</a>，选择一个机器人</p>
<p><img   src="/2021/11/21/21ffd4d4cd1a/%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%88%97%E8%A1%A8.png" loading="lazy"></p>
<p>在下方添加被通知 QQ 号和被通知 QQ 群，使用被通知 QQ 号加他为好友并把他拉进 QQ 群</p>
<p><img   src="/2021/11/21/21ffd4d4cd1a/%E9%85%8D%E7%BD%AE%E7%BE%A4%E8%81%8A.png" loading="lazy"></p>
<p>将 QQ 群设置为可被根据群号搜索</p>
<p>在<a target="_blank" rel="noopener" href="https://qmsg.zendee.cn/api.html">文档</a>页面进行 QQ 群消息推送权限的申请，然后等待申请通过（需要 24h 左右），<strong>只有申请通过后才可以向 QQ 群推送消息</strong></p>
<p><img   src="/2021/11/21/21ffd4d4cd1a/%E7%94%B3%E8%AF%B7%E6%8E%A8%E9%80%81.png" loading="lazy"></p>
<p>检查系统时间是否正确</p>
<p><img   src="/2021/11/21/21ffd4d4cd1a/%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%97%B4.png" loading="lazy"></p>
<p>注册一个 gitee 账号</p>
<p>demo 地址：<a target="_blank" rel="noopener" href="https://gitee.com/vvv4230/hebut-night-clock-in-demo">https://gitee.com/vvv4230/hebut-night-clock-in-demo</a></p>
<p>服务器执行 <code>git clone git@gitee.com:vvv4230/hebut-night-clock-in-demo.git</code></p>
<p>此时执行 ls， 你应该可以看到一个名为 hebut-night-clock-in-demo 的文件夹</p>
<p>使用 <code>pwd</code> 查看当前目录路径，记住详细路径</p>
<p>安装依赖</p>
<pre><code class="shell">cd hebut-night-clock-in-demo
npm i --registry=https://registry.npmmirror.com
</code></pre>
<p>学习使用 <code>nano / vi / vim</code> 编辑文件，将工程下 config.json 中配置项改为你自己的</p>
<pre><code class="json">&#123;
    &quot;QMSGKey&quot;: &quot;axxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx0&quot;, // qmsg 账号的key
    &quot;username&quot;: &quot;188888&quot;, // 有查看未打卡人数权限的账号
    &quot;password&quot;: &quot;password&quot;, // 账号对应的密码
    &quot;search&quot;: &quot;计182&quot;, // 班级
    &quot;group&quot;: &quot;12345678&quot;, // 被通知的 QQ 群
    &quot;qq&quot;: &quot;4230722&quot; // 被通知人的 QQ
&#125;
</code></pre>
<p>此时让我们测试一下，在项目根目录下执行 <code>node app.js </code>，你应该可以在 QQ 上收到对应通知了</p>
<p>下面是最后一步了，在<a target="_blank" rel="noopener" href="https://tool.lu/crontab/">cron 表达式生成</a>生成你需要的 cron 时间表达式，他可以用来表示一些周期性时间</p>
<p>执行 <code>crontab -e</code>，填入对应表达式</p>
<p>例如我填入了</p>
<pre><code class="shell">30 22 * * * node /home/ubuntu/hebut-night-clock-in-demo/app.js
00 23 * * * node /home/ubuntu/hebut-night-clock-in-demo/app.js
</code></pre>
<p>表示在 <code>30 22 * * *</code> (每天 22:30)执行 <code>node /home/ubuntu/hebut-night-clock-in-demo/app.js</code> 命令</p>
<p>和在 <code>00 23 * * *</code> (每天 23:00)执行 <code>node /home/ubuntu/hebut-night-clock-in-demo/app.js</code> 命令</p>
<p><code>/home/ubuntu</code> 路径即为 <code>pwd</code> 命令查询到的 hebut-night-clock-in-demo 文件夹所在的路径</p>
<p><img   src="/2021/11/21/21ffd4d4cd1a/crontab.png" loading="lazy"></p>
<p>好的，配置完成~</p>
<p>如果有兴趣，你可以再完成下面两件事：</p>
<ul>
<li>完善错误处理</li>
<li>按照 qmsg 文档，在提示信息中加入 @ 对应同学的操作</li>
</ul>
<h2 id="好奇原理"><a href="#好奇原理" class="headerlink" title="好奇原理"></a>好奇原理</h2><h3 id="把大象装进冰箱分为几步"><a href="#把大象装进冰箱分为几步" class="headerlink" title="把大象装进冰箱分为几步"></a>把大象装进冰箱分为几步</h3><ol>
<li>从疫情防控小程序后端接口获取未打卡数据</li>
<li>将未打卡人员名单推送到 QQ 群</li>
<li>设置定时任务在特定时间点执行我们的程序</li>
</ol>
<h3 id="获取未打卡数据"><a href="#获取未打卡数据" class="headerlink" title="获取未打卡数据"></a>获取未打卡数据</h3><h4 id="接口抓取"><a href="#接口抓取" class="headerlink" title="接口抓取"></a>接口抓取</h4><p>疫情防控小程序没有提供对外服务，所以为了达到目的，我们需要 hack 一下</p>
<p>这里用<strong>反编译微信小程序</strong>和<strong>抓包软件</strong>配合，细节在此不表，分析获得接口：</p>
<p>baseURL：<a target="_blank" rel="noopener" href="https://yqfw.hebut.edu.cn/api/">https://yqfw.hebut.edu.cn/api/</a></p>
<h5 id="登录接口（JWT）"><a href="#登录接口（JWT）" class="headerlink" title="登录接口（JWT）"></a>登录接口（JWT）</h5><p>POST    <code>/logins</code></p>
<p>Headers: Referer、User-Agent、code</p>
<p>body:</p>
<pre><code class="json">&#123;
  &quot;data&quot;: &quot;[隐去]&quot;,
  &quot;code&quot;: &quot;[隐去]&quot;
&#125;
</code></pre>
<p>data 和 code 生成逻辑如下</p>
<pre><code class="javascript">const blueTower = require(&#39;./blue-tower&#39;)
const loginModel = &#123;
    username: &#39;188888&#39;,
    password: &#39;password&#39;
&#125;
const code = blueTower.getUUID();
const data = blueTower.encrypts(JSON.stringify(loginModel), code);
</code></pre>
<p>Response 中可以拿到 token</p>
<h5 id="查询未打卡人员"><a href="#查询未打卡人员" class="headerlink" title="查询未打卡人员"></a>查询未打卡人员</h5><p>GET    <code>/hm/stats/night/user/list</code></p>
<p>query: <code>date=$&#123;date&#125;&amp;dayStu=9&amp;leave=9&amp;inFlag=9&amp;fillFlag=&amp;fillType=&amp;type=1&amp;search=$&#123;search&#125;&amp;pageNum=$&#123;pageNum&#125;</code></p>
<p>Headers: Referer、User-Agent、token</p>
<p>具体参数含义没有全部分析，我们只需要知道 <code>date</code>、<code>search</code>、<code>pageNum</code> 分别代表欲查询数据的<strong>日期</strong>、<strong>关键字</strong>、<strong>分页页数</strong>属性</p>
<p>Response 中可以拿到 list 和 count，再以此计算去请求所有分页获得完整列表</p>
<p><em>吐槽一下：这个分页查询接口有严重 bug，不同页存在重复数据，同时也就有可能无法获取准确全量数据（即使是在疫情防控小程序中）</em></p>
<h4 id="程序编写"><a href="#程序编写" class="headerlink" title="程序编写"></a>程序编写</h4><p>简单说就是我们让我们的程序去模拟疫情防控小程序的<strong>登录</strong>和<strong>查询未打卡人员</strong>的相关请求</p>
<p><img   src="/%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B.png" loading="lazy"></p>
<h3 id="推送到-QQ-群"><a href="#推送到-QQ-群" class="headerlink" title="推送到 QQ 群"></a>推送到 QQ 群</h3><h4 id="消息推送方式"><a href="#消息推送方式" class="headerlink" title="消息推送方式"></a>消息推送方式</h4><ul>
<li>邮件、短信</li>
<li>应用（企业微信、飞书、钉钉）的官方推送接口</li>
<li>对于无官方接口应用（QQ、微信）的第三方灰色推送服务（酷Q机器人、晨风机器人、server 酱、qmsg 酱）</li>
</ul>
<h4 id="qmsg-酱使用"><a href="#qmsg-酱使用" class="headerlink" title="qmsg 酱使用"></a>qmsg 酱使用</h4><p>打开<a target="_blank" rel="noopener" href="https://qmsg.zendee.cn/">qmsg 酱官网</a>，注册登录，确保你的欲通知人（群）加了推送机器人为好友，如果是推送消息到群，需要提供群号经过 qmsg 的审核</p>
<p>webhook 调用示例</p>
<pre><code class="javascript">function send2Group(group, msg) &#123;
    return axios.post(`https://qmsg.zendee.cn/group/$&#123;QMSGKey&#125;`, qs.stringify(&#123;
        msg,
        qq: group
    &#125;))
&#125;
</code></pre>
<h3 id="设置为定时任务"><a href="#设置为定时任务" class="headerlink" title="设置为定时任务"></a>设置为定时任务</h3><ul>
<li><p>方式一：在 Linux 服务器上，使用 cron 设置定时执行任务，<a target="_blank" rel="noopener" href="https://tool.lu/crontab/">cron 表达式生成</a></p>
</li>
<li><p>方式二：云厂商的云函数执行方式</p>
</li>
</ul>
<h2 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h2><p>如果有兴趣，你可以再完成下面两件事：</p>
<ul>
<li>完善错误处理</li>
<li>按照 qmsg 文档，在提示信息中加入 @ 对应同学的操作</li>
</ul>
<p>更建议自己动手从头实现一番，编程语言不限</p>

        <!-- 分类文章 -->
        
      </div>
      <div class="post-content-inner-space">
        
          <div class="space-toc-main animate__animated  animate__fadeInUp">
            <ol class="space-toc"><li class="space-toc-item space-toc-level-2"><a class="space-toc-link" href="#%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="space-toc-text">写在前面</span></a></li><li class="space-toc-item space-toc-level-2"><a class="space-toc-link" href="#%E4%BB%85%E4%BB%85%E6%83%B3%E4%BD%BF%E7%94%A8"><span class="space-toc-text">仅仅想使用</span></a><ol class="space-toc-child"><li class="space-toc-item space-toc-level-3"><a class="space-toc-link" href="#%E7%A8%8B%E5%BA%8F%E6%95%88%E6%9E%9C"><span class="space-toc-text">程序效果</span></a></li><li class="space-toc-item space-toc-level-3"><a class="space-toc-link" href="#%E5%87%86%E5%A4%87%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%B9%B6%E5%AE%89%E8%A3%85%E7%8E%AF%E5%A2%83"><span class="space-toc-text">准备服务器并安装环境</span></a></li><li class="space-toc-item space-toc-level-3"><a class="space-toc-link" href="#%E5%87%86%E5%A4%87%E5%A5%BD-qmsg-%E6%9C%BA%E5%99%A8%E4%BA%BA"><span class="space-toc-text">准备好 qmsg 机器人</span></a></li></ol></li><li class="space-toc-item space-toc-level-2"><a class="space-toc-link" href="#%E5%A5%BD%E5%A5%87%E5%8E%9F%E7%90%86"><span class="space-toc-text">好奇原理</span></a><ol class="space-toc-child"><li class="space-toc-item space-toc-level-3"><a class="space-toc-link" href="#%E6%8A%8A%E5%A4%A7%E8%B1%A1%E8%A3%85%E8%BF%9B%E5%86%B0%E7%AE%B1%E5%88%86%E4%B8%BA%E5%87%A0%E6%AD%A5"><span class="space-toc-text">把大象装进冰箱分为几步</span></a></li><li class="space-toc-item space-toc-level-3"><a class="space-toc-link" href="#%E8%8E%B7%E5%8F%96%E6%9C%AA%E6%89%93%E5%8D%A1%E6%95%B0%E6%8D%AE"><span class="space-toc-text">获取未打卡数据</span></a></li><li class="space-toc-item space-toc-level-3"><a class="space-toc-link" href="#%E6%8E%A8%E9%80%81%E5%88%B0-QQ-%E7%BE%A4"><span class="space-toc-text">推送到 QQ 群</span></a></li><li class="space-toc-item space-toc-level-3"><a class="space-toc-link" href="#%E8%AE%BE%E7%BD%AE%E4%B8%BA%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="space-toc-text">设置为定时任务</span></a></li></ol></li><li class="space-toc-item space-toc-level-2"><a class="space-toc-link" href="#%E5%86%99%E5%9C%A8%E6%9C%80%E5%90%8E"><span class="space-toc-text">写在最后</span></a></li></ol>
           </div>
        
      </div>
   </div>
    <!-- 评论 -->
    
  </div>
</article>
  </div>
</div>



<!-- 如果是home模式的话，不在首页就显示footer，如果不是home模式的话 所有都显示footer -->

  <div class="footer-outer animate__animated  animate__fadeInUp">
    <div class="footer-inner">
        <div class="footer-text">
        <p>Power by <a target="_blank" rel="noopener" href="http://hexo.io/">Hexo</a> Theme by <a target="_blank" rel="noopener" href="https://github.com/FuShaoLei/hexo-theme-white">White</a></p>

        </div>
        <div class="footer-text">
            <p>备案号：<a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">冀ICP备19000020号-4</a></p>

        </div>
        <div class="footer-contact">
        <ul class="footer-ul">
            
            <li class="footer-li">
                <a href="mailto:4230722[at]qq.com" target="_blank">
                    <i class="ri-mail-line"></i>
                </a>
            </li>
            
        </ul>
        </div>
    </div>
    <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?950c37bafe6776c7436e0b3647793dbf";
          var s = document.getElementsByTagName("script")[0]; 
          s.parentNode.insertBefore(hm, s);
        })();
    </script>
</div>






<script src="/js/white.js"></script>



    
      
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@9.18.1/build/highlight.min.js"></script>

      <script>hljs.initHighlightingOnLoad();</script>
    

</body>
</html>
